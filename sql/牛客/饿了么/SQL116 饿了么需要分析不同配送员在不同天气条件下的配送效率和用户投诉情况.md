## ***\**\*SQL116 饿了么需要分析不同配送员在不同天气条件下的配送效率和用户投诉情况\*\**\***

### 做什么

【要求】：根据上述表格，查询出每种天气类型下，平均配送速度大于 20 且投诉率（投诉数量 / 配送订单总数量）低于50%的所有配送员的每单平均配送时间，配送的总次数。查询结果按照天气类型升序排列。要求查询出来的表格的字段如下：

weather_type: 天气类型。

average_delivery_time: 平均配送时间。（round保留2位小数）

delivery_count: 配送总次数。

【示例】

delivery_staff（配送员）表:

weather_conditions （天气条件）表:

delivery_records （配送记录）表:

【按要求查询出来的表】

【解释】

上述示例中天气类型涉及2种，分别是weather_id (天气 ID) 1和2，其中weather_id (天气 ID) 1相关的配送记录有2条，分别是record_id 1和3，record_id 1和3的配送员都是staff_id (配送员 ID) 1，配送速度是25超过了20，且该配送员的投诉率 = 0 / 2 = 0；所以该配送员符合要求，该配送员的每单平均配送时间是（30+20）/2 = 25；配送总次数是2；



- 查询出每种天气类型下 （分组）
- 平均配送速度大于 20 且投诉率（投诉数量 / 配送订单总数量）低于50%的配送员 两个条件筛选配送员
- 符合条件的所有配送员的每单平均配送时间，配送的总次数

### 怎么做

- delivery_staff和delivery_records表 筛出符合条件的配送员id和其对应的天气类型
- 连接staff表 直接筛出配速大于20的员工
- 按照delivery.weather_id和delivery.staff_id 进行分组
- 使用having avg(is_complaint) 得到差评率小于0.5的分组结果
- 使用with创建临时表

```
with t as(
select
    d1.weather_id,
    d1.staff_id
from delivery_records d1
#连接staff表 直接筛出配速大于20的员工
join delivery_staff d2
on d1.staff_id = d2.staff_id and d2.average_speed >20
#按照delivery.weather_id和delivery.staff_id 进行分组
group by d1.weather_id,d1.staff_id
#使用having avg(is_complaint) 得到差评率小于0.5的分组结果
having avg(is_complaint)< 0.5
)
```

- 使用临时表得到的weather_id ,staff_id 再去连接delivery_records （配送记录）表 weather_conditions （天气条件）表
- 按照天气分组  这里会将同一天气下的 所有配送员放在一组
- 所以按照题意求全部配送员的平均时间和配送次数即可

```
select 
    w.weather_type,
    round(avg(d.delivery_time),2)average_delivery_time,
    count(delivery_time) delivery_count
from t 
join weather_conditions w on t.weather_id = w.weather_id
join delivery_records d on t.staff_id = d.staff_id
group by w.weather_type
```



### 代码展示

```
with t as(
select
    d1.weather_id,
    d1.staff_id
from delivery_records d1
join delivery_staff d2
on d1.staff_id = d2.staff_id and d2.average_speed >20
group by d1.weather_id,d1.staff_id
having avg(is_complaint)< 0.5
)
select 
    w.weather_type,
    round(avg(d.delivery_time),2)average_delivery_time,
    count(delivery_time) delivery_count
from t 
join weather_conditions w on t.weather_id = w.weather_id
join delivery_records d on t.staff_id = d.staff_id
group by w.weather_type
```