## ***\*SQL115 哪些产品在特定时间段内表现最为出色\****

### 做什么

【要求】：根据上面这两个表格，查询在'2024-01-01' —'2024-12-31'销量最高的产品，包含的字段：产品 ID、产品名称、总销售额、总销量。如果存在销量一样的多个产品，都展示出来且按照产品ID升序排列，要求查询出来的表格的字段如下：

product_id: 产品的唯一标识符。

product_name: 产品的名称。

total_sales_amount: 总销售额。

total_sales_quantity: 总销量。

【示例】：

products（产品）表:

sales_records（销售记录）表:

【按照要求查询出来的表】

【解释】：2024年的订单有4笔，其中产品ID是1和3的销量最高，都是16，所以查询出来产品ID是1和3的产品，他们的总销售金额也一样都是900



- 时间在2024-01-01 - 2024-12-31需要筛选
- 求出销量最高的产品
- 存在销量一样的多个产品，都展示出来  （可以想到写窗口函数判断）
- 根据id排序

### 怎么做

- 筛时间 注意查看sales_date是不是时间类型

```
where sales_date between '2024-01-01' and '2024-12-31'
```

- 求销量   我们看到销售记录表中是有多条销售记录 所以需要根据产品id进行分组聚合才能得到销量以及销售额

```
with t as(
select
    product_id,
    sum(sales_amount) total_sales_amount,
    sum(sales_quantity) total_sales_quantity,
    #rank() over(order by sum(sales_quantity)desc) rk
from sales_records
where sales_date between '2024-01-01' and '2024-12-31'
group by product_id
)
```

- 我们使用rank这个窗口函数 因为可以并排  注意这里不需要再分区

```
rank() over(order by sum(sales_quantity)desc) rk
```

- 我这里是使用with创建临时表 也可以进行子查询  再进行select查询需要的字段即可
- 接下来关联产品表 拿到产品名即可  同时注意筛选rk为1的记录

```
select 
    p.product_id,
    p.product_name,
    t.total_sales_amount,
    t.total_sales_quantity
from products p 
join t 
on p.product_id = t.product_id
where t.rk=1
order by p.product_id
```

### 代码展示

```
with t as(
select
    product_id,
    sum(sales_amount) total_sales_amount,
    sum(sales_quantity) total_sales_quantity,
    rank() over(order by sum(sales_quantity)desc) rk
from sales_records
where sales_date between '2024-01-01' and '2024-12-31'
group by product_id
)


select 
    p.product_id,
    p.product_name,
    t.total_sales_amount,
    t.total_sales_quantity
from products p 
join t 
on p.product_id = t.product_id
where t.rk=1
order by p.product_id
```