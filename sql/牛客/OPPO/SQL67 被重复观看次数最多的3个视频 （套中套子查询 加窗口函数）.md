## ***\*SQL67 被重复观看次数最多的3个视频 （套中套子查询 加窗口函数）\****

### 做什么

请找到那些能让用户一遍接一遍重复观看的高回头率视频，输出被重复观看人次数。若某人对某视频只观看了一次，则不计为重复观看次数，如果某人对某视频观看了n次（n>1），则记为该视频重复观看次数+n。如果被重复观看次数一样大，则越晚发布的视频排名越靠前，每个视频的排名为排在他前面的视频个数+1。请找出被重复观看数排名前三的视频，输出这些视频的课程ID、被重复观看次数和排名。结果按排名升序。若被重复观看视频不足三个，按排名全部输出。示例输出如下：

| cid  | pv    | rk   |
| ---- | ----- | ---- |
| 9002 | 3.000 | 1    |
| 9001 | 2.000 | 2    |

提取题干

- 输出cid（视频id） pv(重复次数) rk(排名)
- 若某人对某视频只观看了一次，则不计为重复观看次数
- 如果某人对某视频观看了n次（n>1），则记为该视频重复观看次数+n。
- 如果被重复观看次数一样大，则越晚发布的视频排名越靠前
- 每个视频的排名为排在他前面的视频个数+1 非并列排序
- 请找出被重复观看数排名前三的视频
- 结果按排名升序。若被重复观看视频不足三个，按排名全部输出。



注意：本题个人认为需要对不同用户对同一视频的观看次数进行累加 但题解多为不累加



### 怎么做

- 这题我们首先处理观看次数，我们对用户观看记录表 play_record_tb 进行查询 按照uid cid分组  因为有重复 最后我们只需要对start_time字段 进行一个count函数计算  即代表观看次数 例如 下面是uid=1001 cid=9001的记录  其观看次数为2   最后我们使用having对结果进行过滤 过滤掉观看次数为1的

| id   |      |      | start_time          | end_time            | score |
| ---- | ---- | ---- | ------------------- | ------------------- | ----- |
| 1    |      |      | 2022-01-01 08:30:00 | 2022-01-01 09:00:00 | 4     |
| 2    |      |      | 2022-01-03 09:30:00 | 2022-01-03 10:20:00 | 2     |

- 接着我们对课程信息表 course_info_tb 与上面的查询得到的表进行关联查询，我们按照cid进行分区这时我们就得到了 在同一视频下 不同用户的重复观看次数记录。我们使用sum函数对重复观看次数进行累加，并用窗口函数ROW_NUMBER进行排名的计算
- 输出前三名  因为ROW_NUMBER函数非并列排名  我们limit 3 取前三条记录即可

### 代码展示

```
select
    c.cid,
    sum(p.pv_num) pv,
    ROW_NUMBER() OVER (
        order by
            sum(pv_num) desc,
            c.release_date desc
    ) rk
from
    course_info_tb c
    join (
        select
            uid,
            cid,
            count(start_time) pv_num
        from
            play_record_tb
        group by
            cid,
            uid
        having
            count(start_time) > 1
    ) p on c.cid = p.cid
group by
    c.cid,
    c.release_date
limit
    3
```