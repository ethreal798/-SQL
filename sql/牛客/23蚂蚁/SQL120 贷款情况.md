## ***\*SQL120 贷款情况\****

### 做什么

【要求】

查询每个城市的客户贷款申请情况，包括每个城市的贷款申请总金额、平均贷款金额、客户数量以及最常申请的贷款类型（如果有多个贷款类型申请数量相同，则选择 loan_type_id 最小的那个），查询结果按照城市名称升序排列。

包含下面的字段：

city: 城市名称

total_loan_amount: 该城市所有客户的贷款申请总金额，保留小数点后2位。

average_loan_amount: 该城市所有客户的平均每个人的贷款申请金额，保留小数点后2位。

total_customers: 该城市的客户数量

most_applied_loan_type: 该城市最常申请的贷款类型名称



- 每个城市的客户贷款申请情况
- 每个城市的贷款申请总金额、 保留小数点后2位。
- 平均贷款金额、 保留小数点后2位。
- 客户数量
- 以及最常申请的贷款类型 （如果有多个贷款类型申请数量相同，则选择 loan_type_id 最小的那个）
- 查询结果按照城市名称升序排列。





### 怎么做

代码层次结构为使用创建两个临时表得到前四个字段（t1）  以及为第五个字段提供条件(t2)

with t1（）,t2()

进行子查询得到第五个字段进行表连接 输出结果

select   

from t1 

join(select  from t2) t3





- 其中前四个条件我们从loan_applications customers表 也就是前两个表 就可以获得

按照题意要求逐步进行即可

```
with t1 as(
select
    c.city,
    round(sum(l.loan_amount),2) total_loan_amount,
    round(sum(l.loan_amount) / count(distinct c.customer_id),2) average_loan_amount,
    count(distinct c.customer_id) total_customers
from loan_applications l 
join customers c on l.customer_id = c.customer_id
group by c.city 
)
```

- 着重观察最后一个条件  首先需要连接四个表
- 如果有多个贷款类型申请数量相同，则选择 loan_type_id 最小的那个   
- 这里其实可以知道是一个排序规则其实就是窗口函数的步骤  根据数量排序然后进行排序选出数量最大的 如果一样则选id小的

1. 首先连接四表得到city type_name type_id
2. 对分组结果进行计数得到同一城市同一贷款类型的结果有多少个
3. 再在外面进行窗口函数查询即可

```
t2 as(
select
    c.city,
    lt.loan_type_name,
    lt.loan_type_id,
    count(*) cnt
from loan_applications l 
join loan_application_types la on l.application_id = la.application_id
join loan_types lt on la.loan_type_id = lt.loan_type_id
join customers c on l.customer_id = c.customer_id
group by c.city,lt.loan_type_name,lt.loan_type_id
)
select
        city,
        loan_type_name,
        row_number() over(partition by city order by cnt desc,loan_type_id)rk
    from t2
```



### 代码展示

```
with t1 as(
select
    c.city,
    round(sum(l.loan_amount),2) total_loan_amount,
    round(sum(l.loan_amount) / count(distinct c.customer_id),2) average_loan_amount,
    count(distinct c.customer_id) total_customers
from loan_applications l 
join customers c on l.customer_id = c.customer_id
group by c.city 
),t2 as(
# 怎么得到# （如果有多个贷款类型申请数量相同，则选择 loan_type_id 最小的那个）
select
    c.city,
    lt.loan_type_name,
    lt.loan_type_id,
    count(*) cnt
from loan_applications l 
join loan_application_types la on l.application_id = la.application_id
join loan_types lt on la.loan_type_id = lt.loan_type_id
join customers c on l.customer_id = c.customer_id
group by c.city,lt.loan_type_name,lt.loan_type_id
)

select
    t1.city,
    t1.total_loan_amount,
    t1.average_loan_amount,
    t1.total_customers,
    t3.loan_type_name most_applied_loan_type
from t1 join 
(
    select
        city,
        loan_type_name,
        row_number() over(partition by city order by cnt desc,loan_type_id)rk
    from t2
)t3 on t1.city = t3.city
where t3.rk = 1
```